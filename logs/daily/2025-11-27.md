# Research Log: 2025-11-27

## Overview
Working on scaling architecture back up to standard size. Encountering gradient explosions when training from scratch on large architecture.

---

## Experiments

### dia_008: MusicGen delay scaled architecture
**Hypothesis:** Scale architecture back up to standard size to see if it can learn the dataset properly

**Setup:**
- Training on 83k samples, 10 seconds each
- Tag shuffle and sliding window turned on
- Architecture config: `20251127_dia_008_musicgen_delay_scaled_model.json`
- Train config: `20251127_dia_008_musicgen_delay_scaled.json`

**Test 1:** Began with batch size of 4 and grad accum steps of 1  
**W&B:** https://wandb.ai/ocamp-university-of-michigan/dia-music-finetuning/groups/musicgen_delay_scaled/runs/5u2zg5pt  
**Result:** After 800 steps gradients started clipping and exploding.

**Test 2:** Decreased batch size to 2 and increased grad accum steps to 16  
**W&B:** https://wandb.ai/ocamp-university-of-michigan/dia-music-finetuning/groups/musicgen_delay_scaled/runs/fkh6kute  
**Result:** This only delayed the gradient explosion.

**Theory:** Haven't trained from scratch yet on such a big architecture so I'm curious if that is the reason for the explosion. I don't think it's the dataset as I've trained a model this size on a smaller dataset and got better results, when I was finetuning an existing model. However I've updated the core delay pattern so can no longer finetune from those weights.

**Test 3:** Increased warmup 500→2000. unconditional_frac → 0.4. learning rate 2e-4 → 1e-4. Epochs → 15. batch size → 4 and grad accum → 1. Swapped quantized bitsandbytes scheduler for regular AdamW  
**W&B:** https://wandb.ai/ocamp-university-of-michigan/dia-music-finetuning/runs/ty86619b

**Next:** Need to scan `dia/finetune_acc.py` for potential reasons why I'm seeing gradient explosions.

---

### dia_tpu_001: TPU initialization (continued)
**Test 1:** Finally ran!  
**W&B:** https://wandb.ai/ocamp-university-of-michigan/audio-finetuning/runs/8ch0nam8  
Stopped cause taking too long.

**Test 2:**
```bash
PT_XLA_DEBUG=0 PYTHONPATH=. accelerate launch dia_tpu/finetune_acc_tpu.py \
  --batch_size 1 --audio_folder /home/olivercamp/local_data/hidenseek \
  --seed 42 --grad_accum_steps 1 --learning_rate 1e-4 --weight_decay 0.1 \
  --warmup_steps 2000 --unconditional_frac 1 --no_decay_embed \
  --epochs 10000 --output_dir output --no_sliding_window --audio_length 600
```

---

## Key Insights
- Gradient explosions when training from scratch on large architecture
- Various attempts to fix (batch size, grad accum, warmup, LR, scheduler) haven't resolved it yet
- Need to investigate training code for potential issues

---

## Commits
- `00:00` [`6535dd0`] **main**: 20251126_dia_tpu_001_init (3 files)
- `00:24` [`d03fa3b`] **main**: 20251126_dia_tpu_001_init (3 files)
- `00:44` [`85c6956`] **main**: 20251126_dia_tpu_001_init (3 files)
- `00:58` [`a9cea7c`] **main**: 20251126_dia_tpu_001_init (3 files)
- `01:30` [`0c74922`] **main**: 20251127_dia_008_musicgen_delay_scaled (6 files)
- `01:51` [`d041140`] **main**: 20251127_dia_008_musicgen_delay_scaled (5 files)
- `02:17` [`112ca62`] **main**: 20251126_dia_tpu_001_init (3 files)
- `02:36` [`948d290`] **main**: 20251126_dia_tpu_001_init (3 files)
- `02:43` [`67a349e`] **main**: 20251126_dia_tpu_001_init (3 files)
- `02:51` [`617fd55`] **main**: 20251126_dia_tpu_001_init (3 files)
- `03:03` [`fda6b22`] **main**: 20251126_dia_tpu_001_init (3 files)
- `03:13` [`991c8a3`] **main**: dac_verify.py (3 files)
- `03:32` [`a8cea7f`] **main**: dac_verify.py (8 files)
- `03:36` [`71a5130`] **main**: dac_verify.py (3 files)
- `03:46` [`cb7aaea`] **main**: dac_verify.py (3 files)
- `03:49` [`0c41f7b`] **main**: 20251126_dia_tpu_001_init (3 files)
- `03:52` [`3a2d1da`] **main**: 20251126_dia_tpu_001_init (3 files)
- `03:55` [`be2ca4f`] **main**: 20251126_dia_tpu_001_init (4 files)
- `04:00` [`1f1a4e5`] **main**: 20251126_dia_tpu_001_init (3 files)
- `04:03` [`ec1b7ce`] **main**: 20251126_dia_tpu_001_init (3 files)
- `04:06` [`d5c6a6f`] **main**: 20251126_dia_tpu_001_init (3 files)
- `04:10` [`75f9d56`] **main**: 20251126_dia_tpu_001_init (3 files)
- `04:24` [`6f41fec`] **main**: 20251126_dia_tpu_001_init (4 files)
- `04:56` [`e889bcc`] **main**: 20251126_dia_tpu_001_init (3 files)
- `05:09` [`a707a10`] **main**: 20251126_dia_tpu_001_init (3 files)
- `05:19` [`35623bc`] **main**: 20251126_dia_tpu_001_init (3 files)
- `12:50` [`9423f71`] **main**: 20251126_dia_tpu_001_init (5 files)
- `13:05` [`e0adf23`] **main**: 20251126_dia_tpu_001_init (4 files)
- `13:11` [`365419d`] **main**: 20251126_dia_tpu_001_init (3 files)
- `14:10` [`a827c10`] **main**: 20251126_dia_tpu_001_init (5 files)
- `14:19` [`7864286`] **main**: 20251127_dia_008_musicgen_delay_scaled (3 files)
- `14:26` [`edc61b1`] **main**: 20251126_dia_tpu_001_init (5 files)
- `14:36` [`16f3c81`] **main**: 20251126_dia_tpu_001_init (3 files)
- `14:43` [`36eaa71`] **main**: 20251126_dia_tpu_001_init (3 files)
- `14:49` [`7a355f8`] **main**: 20251126_dia_tpu_001_init (3 files)
- `15:44` [`ce678a0`] **main**: 20251126_dia_tpu_001_init (3 files)
- `15:52` [`ae39f17`] **main**: 20251126_dia_tpu_001_init (3 files)
